
    <div class="page-container">
      <h1>Settings</h1>
      
      <!-- Loading spinner - viewport-centered -->
      @if (initializing()) {
        <app-loading-spinner [fixed]="true" message="Loading settings..." />
      }
      
      <div class="settings-layout d-flex gap-3" [class.initializing]="initializing()">
        <!-- Vertical Nav Pills -->
        <ul ngbNav #nav="ngbNav" [(activeId)]="activeTab" class="nav-pills flex-column settings-nav flex-shrink-0" style="width: 200px;" [class.disabled]="initializing()">
          <li [ngbNavItem]="1">
            <button ngbNavLink [disabled]="initializing()" class="d-flex align-items-center gap-2">
              <i class="bi bi-box-seam"></i>
              <span>Installation</span>
            </button>
            <ng-template ngbNavContent>
              <div class="content-section">
                <h2>Installation & Updates</h2>
                
                @if (storeLoading()) {
                  <div class="d-flex justify-content-center p-5">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                } @else if (error() || storeError()) {
                  <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    {{ error() || storeError() }}
                  </div>
                } @else {
                
                  <!-- Software Version Cards -->
                  <div class="software-cards">
                    
                    <!-- ODX Launcher Card -->
                    <div class="software-card">
                      <div class="software-header">
                        <div class="software-icon odx-icon">
                          <i class="bi bi-rocket-takeoff"></i>
                        </div>
                        <div class="software-title">
                          <h3>ODX Launcher</h3>
                          <p class="text-muted mb-0">Application Version</p>
                        </div>
                      </div>
                      
                      <div class="software-body">
                        <div class="version-info">
                          <div class="current-version">
                            <span class="version-label">Current</span>
                            <span class="version-number">{{ appVersion }}</span>
                          </div>
                          
                          @if (autoUpdateService.state() === 'available' && autoUpdateService.updateInfo(); as odxUpdate) {
                            <div class="update-badge">
                              <i class="bi bi-arrow-up-circle-fill text-primary"></i>
                              <span>{{ odxUpdate.version }} available</span>
                            </div>
                          } @else if (autoUpdateService.state() === 'idle' || autoUpdateService.state() === 'checking') {
                            <div class="status-badge up-to-date">
                              <i class="bi bi-check-circle-fill"></i>
                              <span>Up to date</span>
                            </div>
                          }
                        </div>
                        
                        @if (autoUpdateService.state() === 'downloading' && autoUpdateService.downloadProgress(); as progress) {
                          <div class="update-progress">
                            <div class="progress">
                              <div class="progress-bar progress-bar-striped progress-bar-animated"
                                   [style.width.%]="progress.percent">
                              </div>
                            </div>
                            <small class="text-muted">
                              Downloading {{ Math.round(progress.percent) }}% · {{ autoUpdateService.formatBytes(progress.bytesPerSecond) }}/s
                            </small>
                          </div>
                        }
                        
                        <div class="software-actions">
                          @if (autoUpdateService.state() === 'available') {
                            <button class="btn btn-primary btn-sm" (click)="autoUpdateService.downloadUpdate()">
                              <i class="bi bi-download"></i>
                              <span>Download Update</span>
                            </button>
                          } @else if (autoUpdateService.state() === 'downloaded') {
                            <button class="btn btn-success btn-sm" (click)="autoUpdateService.installAndRestart()">
                              <i class="bi bi-arrow-repeat"></i>
                              <span>Install & Restart</span>
                            </button>
                          } @else {
                            <button class="btn btn-primary btn-sm" (click)="checkForODXUpdate()" 
                                    [disabled]="autoUpdateService.state() === 'checking'">
                              <i class="bi bi-arrow-clockwise" [class.spinning]="autoUpdateService.state() === 'checking'"></i>
                              <span>Check for Updates</span>
                            </button>
                          }
                        </div>
                        
                        <div class="software-meta">
                          <small class="text-muted">
                            <i class="bi bi-calendar3"></i>
                            Released {{ appVersionDate }}
                          </small>
                          @if (appCommitHash) {
                            <small class="text-muted">
                              <i class="bi bi-git"></i>
                              {{ appCommitHash }}
                            </small>
                          }
                        </div>
                      </div>
                    </div>
                    
                    <!-- Odamex Engine Card -->
                    <div class="software-card">
                      <div class="software-header">
                        <div class="software-icon odamex-icon">
                          <i class="bi bi-box-seam"></i>
                        </div>
                        <div class="software-title">
                          <h3>Odamex Engine</h3>
                          <p class="text-muted mb-0">Game Client & Server</p>
                        </div>
                      </div>
                      
                      <div class="software-body">
                        @if (installationInfo()?.installed) {
                          <div class="version-info">
                            <div class="current-version">
                              <span class="version-label">Current</span>
                              <span class="version-number">{{ installationInfo()!.version || 'Unknown' }}</span>
                            </div>
                            
                            @if (installationInfo()!.needsUpdate && installationInfo()!.latestVersion) {
                              <div class="update-badge">
                                <i class="bi bi-arrow-up-circle-fill text-warning"></i>
                                <span>{{ installationInfo()!.latestVersion }} available</span>
                              </div>
                            } @else {
                              <div class="status-badge up-to-date">
                                <i class="bi bi-check-circle-fill"></i>
                                <span>Up to date</span>
                              </div>
                            }
                          </div>
                          
                          <div class="installation-source">
                            <i class="bi bi-folder2-open"></i>
                            @if (installationInfo()!.source === 'odx') {
                              <span>ODX Managed</span>
                            } @else if (installationInfo()!.source === 'system') {
                              <span>System Installation</span>
                            } @else if (installationInfo()!.source === 'custom') {
                              <span>Custom Path</span>
                            }
                          </div>
                          
                          @if (downloading()) {
                            <div class="update-progress">
                              @if (downloadProgress(); as progress) {
                                <div class="progress">
                                  <div class="progress-bar progress-bar-striped progress-bar-animated"
                                       [style.width.%]="progress.percent">
                                  </div>
                                </div>
                                <small class="text-muted">
                                  {{ formatBytes(progress.transferred) }} / {{ formatBytes(progress.total) }} · 
                                  {{ formatBytes(progress.bytesPerSecond) }}/s
                                </small>
                              }
                            </div>
                          }
                          
                          <div class="software-actions">
                            @if (installationInfo()!.needsUpdate) {
                              <button class="btn btn-warning btn-sm" 
                                      [disabled]="downloading()"
                                      (click)="downloadLatest()">
                                <i class="bi bi-download"></i>
                                <span>Update to {{ installationInfo()!.latestVersion }}</span>
                              </button>
                            } @else {
                              <button class="btn btn-primary btn-sm" 
                                      [disabled]="downloading()"
                                      (click)="checkForOdamexUpdate()">
                                <i class="bi bi-arrow-clockwise"></i>
                                <span>Check for Updates</span>
                              </button>
                            }
                            <button class="btn btn-outline-secondary btn-sm" (click)="openDir(installationInfo()!.path!)">
                              <i class="bi bi-folder2-open"></i>
                              <span>Open Folder</span>
                            </button>
                          </div>
                          
                          <div class="software-meta">
                            <small class="text-muted d-block">
                              <i class="bi bi-hdd"></i>
                              {{ installationInfo()!.path }}
                            </small>
                          </div>
                        } @else {
                          <div class="not-installed">
                            <i class="bi bi-exclamation-circle text-warning"></i>
                            <p>Odamex is not installed</p>
                            <button class="btn btn-success" 
                                    [disabled]="downloading()"
                                    (click)="downloadLatest()">
                              @if (downloading()) {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Downloading...</span>
                              } @else {
                                <i class="bi bi-download"></i>
                                <span class="ms-2">Download & Install</span>
                              }
                            </button>
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                  
                  <!-- Advanced Options -->
                  <div class="advanced-section">
                    <h3 class="section-title">
                      <i class="bi bi-gear"></i>
                      Advanced Options
                    </h3>
                    
                    <div class="form-check form-switch">
                      <input 
                        class="form-check-input" 
                        type="checkbox" 
                        id="useCustomPath"
                        [checked]="useCustomPath()"
                        (change)="toggleCustomPath()">
                      <label class="form-check-label" for="useCustomPath">
                        Use custom Odamex installation path
                      </label>
                    </div>
                    
                    @if (useCustomPath()) {
                      <div class="custom-path-input mt-3">
                        <label class="form-label">Custom Installation Path</label>
                        <div class="input-group">
                          <input 
                            type="text" 
                            class="form-control" 
                            placeholder="C:\Path\To\Odamex"
                            [value]="customPath()"
                            (input)="updateCustomPath($any($event.target).value)">
                          <button class="btn btn-outline-secondary" type="button" (click)="loadData()">
                            <i class="bi bi-arrow-clockwise"></i>
                            <span>Refresh</span>
                          </button>
                        </div>
                        <small class="text-muted">
                          Enter the directory containing odamex.exe (Windows) or odamex binary (Mac/Linux)
                        </small>
                      </div>
                    }
                    
                    <!-- Directories Section -->
                    <div class="directories-section mt-4">
                      <h4>Application Directories</h4>
                      @if (directories()) {
                        <div class="directory-list">
                          <div class="directory-item">
                            <div class="directory-info">
                              <i class="bi bi-folder"></i>
                              <div>
                                <span class="directory-label">ODX Directory</span>
                                <span class="directory-path">{{ directories()!.odx }}</span>
                              </div>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" (click)="openDir(directories()!.odx)">
                              <i class="bi bi-box-arrow-up-right"></i>
                              <span>Open</span>
                            </button>
                          </div>
                          
                          <div class="directory-item">
                            <div class="directory-info">
                              <i class="bi bi-file-earmark-binary"></i>
                              <div>
                                <span class="directory-label">Binaries</span>
                                <span class="directory-path">{{ directories()!.bin }}</span>
                              </div>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" (click)="openDir(directories()!.bin)">
                              <i class="bi bi-box-arrow-up-right"></i>
                             <span>Open</span>
                            </button>
                          </div>
                          
                          <div class="directory-item">
                            <div class="directory-info">
                              <i class="bi bi-file-earmark-zip"></i>
                              <div>
                                <span class="directory-label">WADs</span>
                                <span class="directory-path">{{ directories()!.wads }}</span>
                              </div>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" (click)="openDir(directories()!.wads)">
                              <i class="bi bi-box-arrow-up-right"></i>
                              <span>Open</span>
                            </button>
                          </div>
                          
                          <div class="directory-item">
                            <div class="directory-info">
                              <i class="bi bi-gear"></i>
                              <div>
                                <span class="directory-label">Config</span>
                                <span class="directory-path">{{ directories()!.config }}</span>
                              </div>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" (click)="openDir(directories()!.config)">
                              <i class="bi bi-box-arrow-up-right"></i>
                              <span>Open</span>
                            </button>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            </ng-template>
          </li>
          <li [ngbNavItem]="2">
            <button ngbNavLink class="d-flex align-items-center gap-2">
              <i class="bi bi-sliders"></i>
              <span>Application</span>
            </button>
            <ng-template ngbNavContent>
              <div class="content-section">
                <h2>Application Settings</h2>
                <p class="text-muted mb-4">Configure general application behavior and preferences</p>
                
                <!-- General Settings Card -->
                <div class="settings-card mb-4">
                  <div class="card-header">
                    <div class="card-title">
                      <i class="bi bi-sliders"></i>
                      <h3>General</h3>
                    </div>
                  </div>
                  
                  <div class="card-body">
                    <div class="setting-item">
                      <div class="form-check form-switch">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          id="autoUpdateCheck"
                          [checked]="updatesService.isCheckEnabled()"
                          (change)="toggleAutoUpdateCheck()">
                        <label class="form-check-label" for="autoUpdateCheck">
                          Check for updates on startup
                        </label>
                      </div>
                      <small class="text-muted">
                        Automatically check for Odamex engine updates when the launcher starts
                      </small>
                    </div>

                    <div class="setting-item">
                      <div class="form-check form-switch">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          id="filterByVersion"
                          [checked]="filterByVersion()"
                          (change)="toggleFilterByVersion()">
                        <label class="form-check-label" for="filterByVersion">
                          Filter servers by current major version
                        </label>
                      </div>
                      <small class="text-muted">
                        Only show servers matching your Odamex major version (recommended)
                      </small>
                      @if (!filterByVersion()) {
                        <div class="alert alert-warning mb-0 mt-2">
                          <i class="bi bi-exclamation-triangle-fill"></i>
                          <strong>Warning:</strong> Connecting to servers with different major versions may cause compatibility issues.
                        </div>
                      }
                    </div>

                    <div class="setting-item mb-0">
                      <div class="form-check form-switch">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          id="autoRefresh"
                          [checked]="autoRefreshEnabled()"
                          (change)="toggleAutoRefresh()">
                        <label class="form-check-label" for="autoRefresh">
                          Auto-refresh server list
                        </label>
                      </div>
                      <small class="text-muted d-block mb-2">
                        Automatically refresh the multiplayer server list at regular intervals
                      </small>
                      @if (autoRefreshEnabled()) {
                        <div class="input-group" style="max-width: 250px;">
                          <input 
                            type="number" 
                            class="form-control form-control-sm" 
                            id="autoRefreshMinutes"
                            min="1"
                            max="60"
                            [value]="autoRefreshMinutes()"
                            (input)="updateAutoRefreshMinutes(+$any($event.target).value)">
                          <span class="input-group-text">minutes</span>
                        </div>
                      }
                    </div>
                  </div>
                </div>

                <!-- Notifications Card -->
                <div class="settings-card mb-4">
                  <div class="card-header">
                    <div class="card-title">
                      <i class="bi bi-bell"></i>
                      <h3>Notifications</h3>
                    </div>
                  </div>
                  
                  <div class="card-body">
                    <div class="setting-item">
                      <div class="form-check form-switch">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          id="notificationsEnabled"
                          [checked]="notificationsEnabled()"
                          (change)="toggleNotifications()">
                        <label class="form-check-label" for="notificationsEnabled">
                          <strong>Enable notifications</strong>
                        </label>
                      </div>
                      <small class="text-muted">
                        Master switch for all notifications
                      </small>
                    </div>

                    @if (notificationsEnabled()) {
                      <div class="notification-options">
                        <h5 class="mt-3 mb-2 text-muted" style="font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Notification Methods</h5>
                        
                        <div class="setting-item">
                          <div class="form-check form-switch">
                            <input 
                              class="form-check-input" 
                              type="checkbox" 
                              id="notificationsSystem"
                              [checked]="notificationsSystem()"
                              (change)="toggleSystemNotifications()">
                            <label class="form-check-label" for="notificationsSystem">
                              System notifications
                            </label>
                          </div>
                          <small class="text-muted">
                            Show desktop notification popups
                          </small>
                        </div>

                        <div class="setting-item">
                          <div class="form-check form-switch">
                            <input 
                              class="form-check-input" 
                              type="checkbox" 
                              id="notificationsTaskbarFlash"
                              [checked]="notificationsTaskbarFlash()"
                              (change)="toggleTaskbarFlash()">
                            <label class="form-check-label" for="notificationsTaskbarFlash">
                              Taskbar flash and sound
                            </label>
                          </div>
                          <small class="text-muted">
                            Flash taskbar and play sound
                          </small>
                        </div>

                        <h5 class="mt-3 mb-2 text-muted" style="font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Notification Types</h5>
                        
                        <div class="setting-item">
                          <div class="form-check form-switch">
                            <input 
                              class="form-check-input" 
                              type="checkbox" 
                              id="notificationsServerActivity"
                              [checked]="notificationsServerActivity()"
                              (change)="toggleServerActivityNotifications()">
                            <label class="form-check-label" for="notificationsServerActivity">
                              Server activity
                            </label>
                          </div>
                          <small class="text-muted">
                            Get notified when new servers appear or players join/leave
                          </small>
                        </div>

                        <div class="setting-item mb-0">
                          <div class="form-check form-switch">
                            <input 
                              class="form-check-input" 
                              type="checkbox" 
                              id="notificationsUpdates"
                              [checked]="notificationsUpdates()"
                              (change)="toggleUpdateNotifications()">
                            <label class="form-check-label" for="notificationsUpdates">
                              Updates
                            </label>
                          </div>
                          <small class="text-muted">
                            Get notified when updates are available for Odamex or ODX Launcher
                          </small>
                        </div>
                      </div>
                    }
                  </div>
                </div>

                <!-- Update Checking Card -->
                <div class="settings-card mb-4">
                  <div class="card-header">
                    <div class="card-title">
                      <i class="bi bi-arrow-repeat"></i>
                      <h3>Update Checking</h3>
                    </div>
                  </div>
                  
                  <div class="card-body">
                    <div class="setting-item">
                      <div class="form-check form-switch">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          id="autoUpdateEnabled"
                          [checked]="autoUpdateEnabled()"
                          (change)="toggleAutoUpdate()">
                        <label class="form-check-label" for="autoUpdateEnabled">
                          <strong>Automatically install ODX Launcher updates</strong>
                        </label>
                      </div>
                      <small class="text-muted">
                        When enabled, ODX updates will download and install automatically on startup. Otherwise, you'll be prompted.
                      </small>
                    </div>

                    <div class="setting-item mb-0">
                      <div class="form-check form-switch">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          id="periodicUpdateCheck"
                          [checked]="periodicUpdateEnabled()"
                          (change)="togglePeriodicUpdateCheck()">
                        <label class="form-check-label" for="periodicUpdateCheck">
                          Check for updates periodically
                        </label>
                      </div>
                      <small class="text-muted d-block mb-2">
                        Automatically check for Odamex and ODX Launcher updates in the background
                      </small>
                      @if (periodicUpdateEnabled()) {
                        <div class="input-group" style="max-width: 250px;">
                          <input 
                            type="number" 
                            id="periodicUpdateInterval" 
                            class="form-control form-control-sm" 
                            min="15"
                            max="1440"
                            [value]="periodicUpdateInterval()"
                            (input)="updatePeriodicUpdateInterval(+$any($event.target).value)">
                          <span class="input-group-text">minutes</span>
                        </div>
                        <small class="text-muted d-block mt-1">
                          Recommended: 60 minutes. Range: 15 minutes to 24 hours
                        </small>
                      }
                    </div>
                  </div>
                </div>

                <!-- Advanced Card -->
                <div class="settings-card">
                  <div class="card-header">
                    <div class="card-title">
                      <i class="bi bi-tools"></i>
                      <h3>Advanced</h3>
                    </div>
                  </div>
                  
                  <div class="card-body">
                    <div class="setting-item mb-0">
                      <h5>Reset Configuration</h5>
                      <p class="text-muted mb-3">
                        Reset your installation preferences to reconfigure the Odamex installation path. This will show the first-run setup dialog again.
                      </p>
                      <button class="btn btn-warning" (click)="resetFirstRunConfig()">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span>Reset to Defaults</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </ng-template>
          </li>
          <li [ngbNavItem]="3">
            <button ngbNavLink class="d-flex align-items-center gap-2">
              <i class="bi bi-lightning-charge-fill"></i>
              <span>Quick Match</span>
            </button>
            <ng-template ngbNavContent>
              <div class="content-section">
                <h2>Quick Match Settings</h2>
                <div class="d-flex justify-content-between align-items-start">
                  <p class="text-muted">Customize your automatic matchmaking preferences</p>
                  <div class="mb-4">
                    <button class="btn btn-outline-warning" (click)="resetQuickMatchSettings()">
                      <i class="bi bi-arrow-counterclockwise"></i>
                      <span>Reset to Defaults</span>
                    </button>
                  </div>
                </div>
                
                <!-- Server Criteria Card -->
                <div class="settings-card mb-4">
                  <div class="card-header">
                    <div class="card-title">
                      <i class="bi bi-funnel"></i>
                      <h3>Server Criteria</h3>
                    </div>
                  </div>
                  
                  <div class="card-body">
                    <!-- Max Ping -->
                    <div class="setting-item">
                      <label class="form-label">
                        <i class="bi bi-speedometer2"></i>
                        Maximum Ping (ms)
                      </label>
                      <p class="setting-description">Only match with servers below this ping threshold</p>
                      <div class="input-group" style="max-width: 200px;">
                        <input 
                          type="number" 
                          class="form-control" 
                          [(ngModel)]="quickMatchCriteria.maxPing"
                          (ngModelChange)="saveQuickMatchSettings()"
                          min="50"
                          max="500"
                          step="10">
                        <span class="input-group-text">ms</span>
                      </div>
                    </div>

                    <hr>

                    <!-- Player Count Range -->
                    <div class="setting-item">
                      <label class="form-label">
                        <i class="bi bi-people-fill"></i>
                        Player Count Range
                      </label>
                      <p class="setting-description">Preferred minimum and maximum number of players</p>
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label small">Minimum Players</label>
                          <input 
                            type="number" 
                            class="form-control" 
                            [(ngModel)]="quickMatchCriteria.minPlayers"
                            (ngModelChange)="saveQuickMatchSettings()"
                            min="0"
                            max="32">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label small">Maximum Players</label>
                          <input 
                            type="number" 
                            class="form-control" 
                            [(ngModel)]="quickMatchCriteria.maxPlayers"
                            (ngModelChange)="saveQuickMatchSettings()"
                            min="1"
                            max="64">
                        </div>
                      </div>
                    </div>

                    <hr>

                    <!-- Monitoring Timeout -->
                    <div class="setting-item">
                      <label class="form-label">
                        <i class="bi bi-clock"></i>
                        Monitoring Timeout
                      </label>
                      <p class="setting-description">How long to monitor for matches when no server is found immediately</p>
                      <div class="input-group" style="max-width: 200px;">
                        <input 
                          type="number" 
                          class="form-control" 
                          [(ngModel)]="quickMatchCriteria.monitoringTimeoutMinutes"
                          (ngModelChange)="saveQuickMatchSettings()"
                          min="1"
                          max="60"
                          step="1">
                        <span class="input-group-text">minutes</span>
                      </div>
                    </div>

                    <hr>

                    <!-- Server Filters -->
                    <div class="setting-item">
                      <label class="form-label">
                        <i class="bi bi-filter"></i>
                        Server Filters
                      </label>
                      
                      <div class="form-check form-switch mb-3">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          id="avoidEmpty"
                          [(ngModel)]="quickMatchCriteria.avoidEmpty"
                          (ngModelChange)="saveQuickMatchSettings()">
                        <label class="form-check-label" for="avoidEmpty">
                          <strong>Avoid Empty Servers</strong>
                          <p class="setting-description mb-0">Skip servers with no players</p>
                        </label>
                      </div>

                      <div class="form-check form-switch">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          id="avoidFull"
                          [(ngModel)]="quickMatchCriteria.avoidFull"
                          (ngModelChange)="saveQuickMatchSettings()">
                        <label class="form-check-label" for="avoidFull">
                          <strong>Avoid Full Servers</strong>
                          <p class="setting-description mb-0">Skip servers at maximum capacity</p>
                        </label>
                      </div>
                    </div>

                    <hr>

                  </div>
                </div>

                <!-- Game Types Card -->
                <div class="settings-card mb-4">
                  <div class="card-header">
                    <div class="card-title">
                      <i class="bi bi-joystick"></i>
                      <h3>Preferred Game Types</h3>
                    </div>
                  </div>
                  
                  <div class="card-body">
                    <div class="setting-item">
                      <p class="setting-description">Select which game modes to include in Quick Match</p>
                      
                      <div class="game-type-grid">
                        <div class="form-check">
                          <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="gtCooperative"
                            [checked]="isGameTypeSelected(0)"
                            (change)="toggleGameType(0)">
                          <label class="form-check-label" for="gtCooperative">
                            Cooperative
                          </label>
                        </div>

                        <div class="form-check">
                          <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="gtDeathmatch"
                            [checked]="isGameTypeSelected(1)"
                            (change)="toggleGameType(1)">
                          <label class="form-check-label" for="gtDeathmatch">
                            Deathmatch
                          </label>
                        </div>

                        <div class="form-check">
                          <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="gtTeamDeathmatch"
                            [checked]="isGameTypeSelected(2)"
                            (change)="toggleGameType(2)">
                          <label class="form-check-label" for="gtTeamDeathmatch">
                            Team Deathmatch
                          </label>
                        </div>

                        <div class="form-check">
                          <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="gtCTF"
                            [checked]="isGameTypeSelected(3)"
                            (change)="toggleGameType(3)">
                          <label class="form-check-label" for="gtCTF">
                            Capture the Flag
                          </label>
                        </div>

                        <div class="form-check">
                          <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="gtSurvival"
                            [checked]="isGameTypeSelected(4)"
                            (change)="toggleGameType(4)">
                          <label class="form-check-label" for="gtSurvival">
                            Survival
                          </label>
                        </div>

                        <div class="form-check">
                          <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="gtHorde"
                            [checked]="isGameTypeSelected(5)"
                            (change)="toggleGameType(5)">
                          <label class="form-check-label" for="gtHorde">
                            Horde
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </ng-template>
          </li>
          <li [ngbNavItem]="4">
            <button ngbNavLink class="d-flex align-items-center gap-2">
              <i class="bi bi-controller"></i>
              <span>Games</span>
            </button>
            <ng-template ngbNavContent>
              <div class="content-section">
                <h2>Game Library</h2>
                <p class="text-muted mb-4">Manage your DOOM game files and WAD directories</p>
                
                <!-- WAD Directories Card -->
                <div class="settings-card mb-4">
                  <div class="card-header">
                    <div class="card-title">
                      <i class="bi bi-folder2-open"></i>
                      <h3>WAD Directories</h3>
                    </div>
                    <button class="btn btn-primary btn-sm" (click)="addDirectory()">
                      <i class="bi bi-folder-plus"></i>
                      <span>Add Directory</span>
                    </button>
                  </div>
                  
                  <div class="card-body">
                    @if (wadDirectories().directories.length === 0) {
                      <div class="empty-state">
                        <i class="bi bi-folder-x"></i>
                        <p>No WAD directories configured</p>
                        <small>Add directories where your DOOM WAD files are located</small>
                      </div>
                    } @else {
                      <div class="list-group directory-list mb-3">
                        @for (dir of wadDirectories().directories; track dir) {
                          <div class="list-group-item">
                            <span><i class="bi bi-folder"></i>{{ dir }}</span>
                            <button class="btn btn-sm btn-outline-danger" 
                                    (click)="removeWADDirectory(dir)"
                                    title="Remove directory">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        }
                      </div>
                    }
                    
                    <div class="form-check form-switch mt-3">
                      <input class="form-check-input" 
                             type="checkbox" 
                             id="scanSteam"
                             [checked]="wadDirectories().scanSteam"
                             (change)="toggleSteamScan($event)">
                      <label class="form-check-label" for="scanSteam">
                        <i class="bi bi-steam me-2"></i>
                        Scan Steam installation directories
                      </label>
                    </div>
                    <small class="text-muted d-block mt-2">
                      Automatically detect DOOM games installed via Steam
                    </small>
                  </div>
                </div>

                <!-- Detected IWADs Card -->
                <div class="settings-card">
                  <div class="card-header">
                    <div class="card-title">
                      <i class="bi bi-joystick"></i>
                      <h3>Detected Games</h3>
                    </div>
                    <button class="btn btn-primary btn-sm" 
                            (click)="rescanIWADs()"
                            [disabled]="iwadService.loading()">
                      @if (iwadService.loading()) {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <span>Scanning...</span>
                      } @else {
                        <i class="bi bi-arrow-clockwise"></i>
                        <span>Rescan</span>
                      }
                    </button>
                  </div>
                  
                  <div class="card-body"
                       [style.opacity]="iwadService.loading() ? 0.5 : 1" 
                       [style.pointer-events]="iwadService.loading() ? 'none' : 'auto'"
                       [style.transition]="'opacity 0.2s'">
                    @if (groupedIWADs().length === 0) {
                      <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <p>No game files detected</p>
                        <small>Add WAD directories above to scan for DOOM, DOOM II, and other IWAD files</small>
                      </div>
                    } @else {
                      <div class="games-grid">
                        @for (group of groupedIWADs(); track group.metadata?.type) {
                          <div class="game-card">
                            <div class="game-icon">
                              <img [src]="'assets/games/' + group.metadata?.imageFilename" 
                                   [alt]="group.metadata?.displayName"
                                   onerror="this.style.display='none'">
                            </div>
                            <div class="game-info">
                              <h5>{{ group.metadata?.displayName }}</h5>
                              <p class="game-description">{{ group.metadata?.description }}</p>
                              <div class="game-details">
                                @if (group.iwads.length === 1) {
                                  <div class="detail-item">
                                    <i class="bi bi-hdd"></i>
                                    <span class="text-truncate">{{ group.iwads[0].path }}</span>
                                  </div>
                                } @else {
                                  <div class="detail-item">
                                    <i class="bi bi-files"></i>
                                    <span>{{ group.iwads.length }} versions found</span>
                                  </div>
                                  @for (iwad of group.iwads; track iwad.path) {
                                    <div class="detail-item small">
                                      <i class="bi bi-dash"></i>
                                      <span class="text-truncate">{{ iwad.path }}</span>
                                    </div>
                                  }
                                }
                              </div>
                            </div>
                          </div>
                        }
                      </div>
                      
                      <div class="stats-footer">
                        <small class="text-muted">
                          <i class="bi bi-info-circle me-1"></i>
                          {{ groupedIWADs().length }} unique game{{ groupedIWADs().length !== 1 ? 's' : '' }} · 
                          {{ detectedIWADs().length }} total IWAD{{ detectedIWADs().length !== 1 ? 's' : '' }}
                        </small>
                      </div>
                    }
                  </div>
                </div>
              </div>
            </ng-template>
          </li>

          <li [ngbNavItem]="5">
            <button ngbNavLink class="d-flex align-items-center gap-2">
              <i class="bi bi-hdd-network-fill"></i>
              <span>Network</span>
            </button>
            <ng-template ngbNavContent>
              <div class="content-section">
                <h2>Network Settings</h2>
                <p class="text-muted mb-4">Configure local network server discovery and scanning</p>
                
                <!-- Local Network Discovery Card -->
                <div class="settings-card mb-4">
                  <div class="card-header">
                    <div class="card-title">
                      <i class="bi bi-hdd-network"></i>
                      <h3>Local Network Discovery</h3>
                    </div>
                  </div>
                  
                  <div class="card-body">
                    <div class="setting-item">
                      <div class="form-check form-switch">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          id="localDiscoveryEnabled"
                          [checked]="localDiscoveryEnabled()"
                          (change)="toggleLocalDiscovery()">
                        <label class="form-check-label" for="localDiscoveryEnabled">
                          <strong>Enable local network scanning</strong>
                        </label>
                      </div>
                      <small class="text-muted">
                        Automatically discover Odamex servers on your local network that may not be listed on the master server
                      </small>
                    </div>

                    @if (localDiscoveryEnabled()) {
                      <!-- Scan Status -->
                      @if (localDiscoveryScanning()) {
                        <div class="alert alert-info d-flex align-items-center gap-2 mt-3 mb-3">
                          <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Scanning...</span>
                          </div>
                          <span>Scanning local networks...</span>
                        </div>
                      } @else if (localDiscoveryLastScan()) {
                        <div class="text-muted mt-3 mb-3">
                          <small>
                            <i class="bi bi-clock-history me-1"></i>
                            Last scan: {{ localDiscoveryLastScan() | date:'short' }}
                          </small>
                        </div>
                      }

                      <!-- Detected Networks -->
                      @if (localDiscoveryNetworks().length > 0) {
                        <div class="mt-3 mb-3">
                          <h5 class="text-muted mb-2" style="font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Detected Networks</h5>
                          <div class="detected-networks-list">
                            @for (network of localDiscoveryNetworks(); track network.name) {
                              <div class="network-item">
                                <div class="network-icon">
                                  <i class="bi bi-ethernet"></i>
                                </div>
                                <div class="network-info">
                                  <div class="network-name">{{ network.name }}</div>
                                  <div class="network-details">
                                    <span class="network-address">{{ network.address }}</span>
                                    <span class="network-separator">/</span>
                                    <span class="network-mask">{{ network.netmask }}</span>
                                  </div>
                                </div>
                                <div class="network-cidr">
                                  <span class="badge">{{ network.cidr }}</span>
                                </div>
                              </div>
                            }
                          </div>
                        </div>
                      }

                      <!-- Advanced Settings (Collapsible) -->
                      <div class="mt-3">
                        <button 
                          class="btn btn-sm btn-link text-decoration-none p-0 d-flex align-items-center gap-1"
                          type="button"
                          (click)="toggleAdvancedDiscovery()">
                          <i class="bi" [class.bi-chevron-right]="!showAdvancedDiscovery()" [class.bi-chevron-down]="showAdvancedDiscovery()"></i>
                          <span>Advanced Settings</span>
                        </button>

                        @if (showAdvancedDiscovery()) {
                          <div class="mt-3 ms-3 border-start border-2 ps-3">
                            <!-- Port Range -->
                            <div class="mb-3">
                              <label class="form-label mb-1">
                                <strong>Port Range</strong>
                              </label>
                              <small class="text-muted d-block mb-2">
                                Range of ports to scan for servers (default: 10666-10675)
                              </small>
                              <div class="d-flex align-items-center gap-2" style="max-width: 350px;">
                                <input 
                                  type="number" 
                                  class="form-control form-control-sm" 
                                  id="portRangeStart"
                                  min="1024"
                                  max="65535"
                                  [value]="localDiscoveryPortStart()"
                                  (input)="updatePortRangeStart(+$any($event.target).value)">
                                <span>to</span>
                                <input 
                                  type="number" 
                                  class="form-control form-control-sm" 
                                  id="portRangeEnd"
                                  min="1024"
                                  max="65535"
                                  [value]="localDiscoveryPortEnd()"
                                  (input)="updatePortRangeEnd(+$any($event.target).value)">
                              </div>
                            </div>

                            <!-- Scan Timeout -->
                            <div class="mb-3">
                              <label for="scanTimeout" class="form-label mb-1">
                                <strong>Scan Timeout</strong>
                              </label>
                              <small class="text-muted d-block mb-2">
                                How long to wait for each server response (default: 200ms)
                              </small>
                              <div class="input-group" style="max-width: 200px;">
                                <input 
                                  type="number" 
                                  class="form-control form-control-sm" 
                                  id="scanTimeout"
                                  min="50"
                                  max="5000"
                                  step="50"
                                  [value]="localDiscoveryScanTimeout()"
                                  (input)="updateScanTimeout(+$any($event.target).value)">
                                <span class="input-group-text">ms</span>
                              </div>
                            </div>

                            <!-- Refresh Interval -->
                            <div class="mb-3">
                              <label for="refreshInterval" class="form-label mb-1">
                                <strong>Refresh Interval</strong>
                              </label>
                              <small class="text-muted d-block mb-2">
                                How often to automatically rescan local networks (default: 60s)
                              </small>
                              <div class="input-group" style="max-width: 200px;">
                                <input 
                                  type="number" 
                                  class="form-control form-control-sm" 
                                  id="refreshInterval"
                                  min="10"
                                  max="600"
                                  step="10"
                                  [value]="localDiscoveryRefreshInterval()"
                                  (input)="updateRefreshInterval(+$any($event.target).value)">
                                <span class="input-group-text">seconds</span>
                              </div>
                            </div>

                            <!-- Max Concurrent Queries -->
                            <div class="mb-0">
                              <label for="maxConcurrent" class="form-label mb-1">
                                <strong>Max Concurrent Queries</strong>
                              </label>
                              <small class="text-muted d-block mb-2">
                                Maximum number of simultaneous server queries (default: 50)
                              </small>
                              <div class="input-group" style="max-width: 200px;">
                                <input 
                                  type="number" 
                                  class="form-control form-control-sm" 
                                  id="maxConcurrent"
                                  min="1"
                                  max="200"
                                  [value]="localDiscoveryMaxConcurrent()"
                                  (input)="updateMaxConcurrent(+$any($event.target).value)">
                                <span class="input-group-text">queries</span>
                              </div>
                            </div>
                          </div>
                        }
                      </div>

                      <!-- Manual Scan Button -->
                      <div class="mt-3">
                        <button 
                          class="btn btn-primary btn-sm"
                          [disabled]="localDiscoveryScanning()"
                          (click)="triggerLocalScan()">
                          <i class="bi bi-arrow-repeat me-1"></i>
                          <span>Scan Now</span>
                        </button>
                      </div>
                    }
                  </div>
                </div>
              </div>
            </ng-template>
          </li>
        </ul>

        <!-- Content Display Area -->
        <div class="settings-content flex-grow-1" [ngbNavOutlet]="nav"></div>
      </div>
    </div>
    
    <!-- Game Selection Dialog -->
    <app-game-selection-dialog
      [visible]="showGameSelection()"
      (completed)="onGameSelectionComplete()"
      (cancelled)="onGameSelectionCancel()" />
    
    <!-- Local Network Discovery Confirmation Dialog -->
    @if (showLocalDiscoveryDialog()) {
      <div class="dialog-overlay" (click)="cancelLocalDiscovery()">
        <div class="dialog-container" (click)="$event.stopPropagation()" style="max-width: 600px;">
          <div class="dialog-header">
            <h2>
              <i class="bi bi-hdd-network-fill me-2"></i>
              Enable Local Network Discovery?
            </h2>
            <p>Automatically discover Odamex servers on your local network</p>
          </div>

          <div class="dialog-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle-fill"></i>
              <div>
                <p><strong>What this does:</strong></p>
                <ul class="mb-0">
                  <li>Scans your local network for Odamex servers</li>
                  <li>Finds servers not listed on the master server</li>
                  <li>Automatically refreshes at regular intervals</li>
                  <li>Works alongside the master server list</li>
                </ul>
              </div>
            </div>

            @if (localDiscoveryNetworks().length > 0) {
              <div class="mt-3">
                <h6 class="text-muted mb-2">Detected Networks</h6>
                <div class="list-group">
                  @for (network of localDiscoveryNetworks(); track network.name) {
                    <div class="list-group-item d-flex align-items-center gap-2 bg-dark border-secondary">
                      <i class="bi bi-ethernet text-primary"></i>
                      <div class="flex-grow-1">
                        <div class="fw-medium">{{ network.name }}</div>
                        <small class="text-muted">{{ network.address }}/{{ network.netmask }}</small>
                      </div>
                      <span class="badge bg-secondary">{{ network.cidr }}</span>
                    </div>
                  }
                </div>
              </div>
            }

            <div class="alert alert-warning mt-3">
              <i class="bi bi-exclamation-triangle-fill"></i>
              <div>
                <p class="mb-0"><strong>Network Activity:</strong> This feature will scan your network using UDP packets. Most home networks handle this without issue, but corporate/managed networks may have restrictions.</p>
              </div>
            </div>
          </div>

          <div class="dialog-footer">
            <button class="btn btn-secondary" (click)="cancelLocalDiscovery()">
              <span>Cancel</span>
            </button>
            <button class="btn btn-primary" (click)="confirmLocalDiscovery()">
              <i class="bi bi-check-circle me-1"></i>
              <span>Enable Discovery</span>
            </button>
          </div>
        </div>
      </div>
    }
  