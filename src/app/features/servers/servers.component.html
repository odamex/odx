
    <div class="server-browser-container" [class.resizing]="resizing()">
      <div class="server-list-area">
        <div class="container-fluid">
          
          <!-- Offline Mode Notice -->
          @if (!isOnline()) {
            <div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
              <i class="bi bi-wifi-off me-2" aria-hidden="true"></i>
              <div>
                <strong>Offline Mode</strong> â€” Server browser is unavailable. Single player and local server hosting are still available.
              </div>
            </div>
          }
          
          <div class="d-flex justify-content-between align-items-center mb-4 gap-4">
            <div>
              <h1 class="mb-0" id="server-browser-title">Server Browser</h1>
              @if (autoRefreshEnabled()) {
                <small class="text-muted" role="status" aria-live="polite">
                  <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> 
                  <span>Auto-refresh active (every {{ autoRefreshMinutes() }} min)</span>
                </small>
              }
            </div>
            
          
            <!-- Search Box -->
            <div class="d-inline-flex flex-grow-0 flex-shrink-1 ms-auto" style="flex-basis:40%;">
              <div class="input-group">
                <span class="input-group-text bg-dark border-secondary">
                  <i class="bi bi-search"></i>
                </span>
                <input 
                  type="text" 
                  class="form-control bg-dark text-light border-secondary" 
                  placeholder="Search servers by name, address, map, or WAD..."
                  [(ngModel)]="searchText"
                  aria-label="Search servers">
                @if (searchText()) {
                  <button 
                    class="btn btn-outline-secondary" 
                    type="button"
                    (click)="searchText.set('')"
                    aria-label="Clear search">
                    <i class="bi bi-x-lg"></i>
                  </button>
                }
              </div>
            </div>
    
            <button 
              class="btn btn-primary" 
              (click)="refreshServers()"
              [disabled]="store.loading() || !isOnline()"
              aria-label="Refresh server list"
              [attr.aria-busy]="store.loading()">
              @if (store.loading()) {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              }
              <span>Refresh</span>
            </button>
          </div>

      <!-- Server List Filters -->
      @if (iwadService.detectedIWADs().length > 0 || getUniqueGames().length > 0) {
        <div class="card server-list-filters bg-dark border-secondary mb-3">
          <div class="card-body py-2">
            <div class="d-flex align-items-center gap-3">
                <i class="bi bi-funnel" aria-hidden="true"></i>
              <div class="dropdown" ngbDropdown>
                <button 
                  class="btn btn-sm btn-outline-light" 
                  type="button" 
                  id="gameFilterDropdown"
                  ngbDropdownToggle
                  aria-label="Game filter menu">
                  @if (showAllGames()) {
                    All Games
                  } @else {
                    Games: <span class="badge bg-primary ms-1">{{ activeGameFilters().length }}</span>
                  }
                </button>
                <div class="dropdown-menu dropdown-menu-dark" ngbDropdownMenu aria-labelledby="gameFilterDropdown">
                  <button class="dropdown-item" type="button" (click)="toggleAllGames()">
                    <i class="bi me-2" [class.bi-check-square-fill]="showAllGames()" [class.bi-square]="!showAllGames()" aria-hidden="true"></i>
                    All Games
                  </button>
                  <div class="dropdown-divider"></div>
                  @for (iwad of getUniqueGames(); track iwad.game) {
                    <button class="dropdown-item" type="button" (click)="toggleGameFilter(iwad.game)"
                       [title]="iwad.detectedCount === 0 ? '0 versions found' : iwad.detectedCount + ' version(s) found'">
                      <i class="bi me-2" [class.bi-check-square-fill]="isGameFilterEnabled(iwad.game)" [class.bi-square]="!isGameFilterEnabled(iwad.game)" aria-hidden="true"></i>
                      {{ iwad.displayName }}
                    </button>
                  }
                </div>
              </div>
              
              <div class="dropdown" ngbDropdown>
                <button 
                  class="btn btn-sm btn-outline-light" 
                  type="button" 
                  id="gameTypeFilterDropdown"
                  ngbDropdownToggle
                  aria-label="Game type filter menu">
                  @if (showAllGameTypes()) {
                    All Game Types
                  } @else {
                    Game Types: <span class="badge bg-primary ms-1">{{ activeGameTypeFilters().length }}</span>
                  }
                </button>
                <div class="dropdown-menu dropdown-menu-dark" ngbDropdownMenu aria-labelledby="gameTypeFilterDropdown">
                  <button class="dropdown-item" type="button" (click)="toggleAllGameTypes()">
                    <i class="bi me-2" [class.bi-check-square-fill]="showAllGameTypes()" [class.bi-square]="!showAllGameTypes()" aria-hidden="true"></i>
                    All Game Types
                  </button>
                  <div class="dropdown-divider"></div>
                  @for (gameType of getUniqueGameTypes(); track gameType.gameType) {
                    <button class="dropdown-item" type="button" (click)="toggleGameTypeFilter(gameType.gameType)"
                       [title]="gameType.count + ' server(s)'">
                      <i class="bi me-2" [class.bi-check-square-fill]="isGameTypeFilterEnabled(gameType.gameType)" [class.bi-square]="!isGameTypeFilterEnabled(gameType.gameType)" aria-hidden="true"></i>
                      {{ gameType.displayName }}
                    </button>
                  }
                </div>
              </div>
              
              <div class="d-flex align-items-center gap-2">
                <label for="maxPingInput" class="mb-0 small text-nowrap text-muted">Max Ping:</label>
                <input 
                  type="number" 
                  class="form-control form-control-sm bg-dark text-light border-secondary" 
                  id="maxPingInput"
                  [(ngModel)]="maxPing"
                  placeholder="Any"
                  min="0"
                  step="10"
                  style="width: 80px;"
                  aria-label="Maximum ping threshold">
                <span class="small text-muted">ms</span>
              </div>
              
              <div class="form-check form-switch">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  id="hideEmptyCheck"
                  [(ngModel)]="hideEmpty"
                  role="switch"
                  aria-label="Hide empty servers">
                <label class="form-check-label small text-muted" for="hideEmptyCheck">
                  Hide Empty
                </label>
              </div>
              
              <div class="ms-auto">
                <button 
                  class="btn btn-sm btn-outline-light"
                  type="button"
                  (click)="openCustomServers()"
                  aria-label="Manage custom servers">
                  <i class="bi bi-server" aria-hidden="true"></i>
                  <span>Custom Servers</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      }
      
      <!-- Custom Servers Modal -->
      <app-custom-servers-modal></app-custom-servers-modal>
      
      @if (store.error()) {
        <div class="alert alert-danger alert-dismissible" role="alert">
          {{ store.error() }}
          <button type="button" class="btn-close" (click)="store.clearError()"></button>
        </div>
      }

      @if (store.loading() && store.servers().length === 0) {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading servers...</span>
          </div>
          <p class="mt-3">Querying master server...</p>
        </div>
      }

      @if (!store.loading() && store.servers().length === 0 && !store.error()) {
        <div class="alert alert-info">
          No servers found. Click Refresh to query the master server.
        </div>
      }

      @if (store.servers().length > 0) {
        <div class="mb-3">
          <small class="text-muted">
            @if (activeGameFilters().length > 0 || filterByVersion()) {
              Showing {{ filteredServers().length }} of {{ store.servers().length }} server(s)
              @if (filterByVersion()) {
                (filtered by version {{ currentMajorVersion() }}.x)
              }
            } @else {
              Found {{ filteredServers().length }} server(s)
              @if (store.localServers().length > 0) {
                ({{ store.localServers().length }} local)
              }
            } 
            @if (store.lastUpdated()) {
              â€¢ Last updated: {{ store.lastUpdated()! | date:'short' }}
            }
          </small>
        </div>

        <div class="table-responsive">
          <table class="table table-dark table-hover" aria-labelledby="server-browser-title">
            <thead>
              <tr>
                <th class="sortable" (click)="sortBy('players')"
                    tabindex="0"
                    role="button"
                    (keydown.enter)="sortBy('players')"
                    (keydown.space)="sortBy('players'); $event.preventDefault()"
                    [attr.aria-sort]="sortColumn() === 'players' ? (sortDirection() === 'asc' ? 'ascending' : 'descending') : 'none'"
                    aria-label="Sort by player count">
                  Players
                  @if (sortColumn() === 'players') {
                    <i class="bi" [class.bi-arrow-up]="sortDirection() === 'asc'" [class.bi-arrow-down]="sortDirection() === 'desc'" aria-hidden="true"></i>
                  }
                </th>
                <th class="sortable" (click)="sortBy('ping')"
                    tabindex="0"
                    role="button"
                    (keydown.enter)="sortBy('ping')"
                    (keydown.space)="sortBy('ping'); $event.preventDefault()"
                    [attr.aria-sort]="sortColumn() === 'ping' ? (sortDirection() === 'asc' ? 'ascending' : 'descending') : 'none'"
                    aria-label="Sort by ping">
                  Ping
                  @if (sortColumn() === 'ping') {
                    <i class="bi" [class.bi-arrow-up]="sortDirection() === 'asc'" [class.bi-arrow-down]="sortDirection() === 'desc'" aria-hidden="true"></i>
                  }
                </th>
                <th class="sortable" (click)="sortBy('name')" 
                    tabindex="0" 
                    role="button"
                    (keydown.enter)="sortBy('name')"
                    (keydown.space)="sortBy('name'); $event.preventDefault()"
                    [attr.aria-sort]="sortColumn() === 'name' ? (sortDirection() === 'asc' ? 'ascending' : 'descending') : 'none'"
                    aria-label="Sort by server name">
                  Server Name
                  @if (sortColumn() === 'name') {
                    <i class="bi" [class.bi-arrow-up]="sortDirection() === 'asc'" [class.bi-arrow-down]="sortDirection() === 'desc'" aria-hidden="true"></i>
                  }
                </th>
                <th>WADs</th>
                <th class="sortable" (click)="sortBy('game')"
                    tabindex="0"
                    role="button"
                    (keydown.enter)="sortBy('game')"
                    (keydown.space)="sortBy('game'); $event.preventDefault()"
                    [attr.aria-sort]="sortColumn() === 'game' ? (sortDirection() === 'asc' ? 'ascending' : 'descending') : 'none'"
                    aria-label="Sort by game">
                  Game
                  @if (sortColumn() === 'game') {
                    <i class="bi" [class.bi-arrow-up]="sortDirection() === 'asc'" [class.bi-arrow-down]="sortDirection() === 'desc'" aria-hidden="true"></i>
                  }
                </th>
                <th class="sortable" (click)="sortBy('gameType')"
                    tabindex="0"
                    role="button"
                    (keydown.enter)="sortBy('gameType')"
                    (keydown.space)="sortBy('gameType'); $event.preventDefault()"
                    [attr.aria-sort]="sortColumn() === 'gameType' ? (sortDirection() === 'asc' ? 'ascending' : 'descending') : 'none'"
                    aria-label="Sort by game type">
                  Game Type
                  @if (sortColumn() === 'gameType') {
                    <i class="bi" [class.bi-arrow-up]="sortDirection() === 'asc'" [class.bi-arrow-down]="sortDirection() === 'desc'" aria-hidden="true"></i>
                  }
                </th>
                <th class="sortable" (click)="sortBy('version')"
                    tabindex="0"
                    role="button"
                    (keydown.enter)="sortBy('version')"
                    (keydown.space)="sortBy('version'); $event.preventDefault()"
                    [attr.aria-sort]="sortColumn() === 'version' ? (sortDirection() === 'asc' ? 'ascending' : 'descending') : 'none'"
                    aria-label="Sort by version">
                  Version
                  @if (sortColumn() === 'version') {
                    <i class="bi" [class.bi-arrow-up]="sortDirection() === 'asc'" [class.bi-arrow-down]="sortDirection() === 'desc'" aria-hidden="true"></i>
                  }
                </th>
              </tr>
            </thead>
            <tbody>
              @for (server of filteredServers(); track server.address.ip + ':' + server.address.port) {
                <tr 
                  [class.table-active]="selectedServer() && selectedServer()!.address.ip === server.address.ip && selectedServer()!.address.port === server.address.port"
                  [class.has-players]="server.players.length > 0"
                  (click)="handleServerClick(server)"
                  (dblclick)="handleServerDoubleClick(server)"
                  (keydown.enter)="handleServerClick(server)"
                  (keydown.space)="handleServerClick(server); $event.preventDefault()"
                  tabindex="0"
                  role="button"
                  [attr.aria-label]="'Server: ' + (server.name || 'Unnamed Server') + ', ' + server.players.length + ' of ' + server.maxPlayers + ' players, ping ' + server.ping + 'ms'"
                  style="cursor: pointer;">
                  <td 
                    [title]="server.players.length + ' active player(s) / ' + server.maxPlayers + ' max player slot(s)' + (server.maxClients && server.maxClients !== server.maxPlayers ? '\n' + (server.maxClients - (server.maxPlayers || 0)) + ' spectator slot(s) available' : '')">
                    {{ server.players.length }} / {{ server.maxPlayers || 0 }}
                  </td>
                  <td>
                    @if (server.ping > 0) {
                      <span [class]="getPingClass(server.ping)">{{ server.ping }}ms</span>
                    } @else {
                      <span class="text-muted">-</span>
                    }
                  </td>
                  <td>
                    {{ server.name || 'Unnamed Server' }}
                    @if (isLocalServer(server)) {
                      <span class="badge bg-info text-dark ms-2" title="Local Network Server">
                        <i class="bi bi-hdd-network me-1"></i>Local
                      </span>
                    }
                    @if (isCustomServer(server)) {
                      <span class="badge bg-warning text-dark ms-2" title="Custom Server">
                        <i class="bi bi-star-fill me-1"></i>Custom
                      </span>
                    }
                    @if (server.passwordHash && server.passwordHash !== '') {
                      <i class="bi bi-lock-fill text-warning ms-2" title="Password protected" aria-label="Password protected"></i>
                    }
                  </td>
                  <td>
                    @if (getServerPWADs(server).length > 0) {
                      <small class="text-muted">{{ getServerPWADs(server).join(', ') }}</small>
                    } @else {
                      <small class="text-muted">-</small>
                    }
                  </td>
                  <td>
                    {{ getServerGame(server) }}
                  </td>
                  <td>{{ getGameTypeName(server.gameType) }}</td>
                  <td>
                    @if (server.versionMajor !== null) {
                      {{ server.versionMajor }}.{{ server.versionMinor }}.{{ server.versionPatch }}
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
      </div>
    </div>

    <!-- Server Details Panel (Bottom Panel) -->
    <div class="server-details-panel" [class.collapsed]="detailsPanelCollapsed()">
      <!-- Resize Handle -->
      <div class="resize-handle" 
           (mousedown)="startResize($event)"
           role="separator"
           aria-label="Resize server details panel"
           aria-orientation="horizontal"></div>
      
      @if (selectedServer()) {
        <div class="card bg-dark border-secondary mb-0">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0" id="server-details-title">
              <i class="bi bi-hdd-network me-2"></i>
              {{ selectedServer()!.name || 'Unnamed Server' }}
            </h5>
            <button 
              class="btn btn-sm btn-outline-secondary" 
              (click)="toggleDetailsPanel()"
              [attr.aria-label]="detailsPanelCollapsed() ? 'Expand details panel' : 'Collapse details panel'"
              title="Toggle details panel">
              <i class="bi" [class.bi-chevron-down]="!detailsPanelCollapsed()" [class.bi-chevron-up]="detailsPanelCollapsed()"></i>
            </button>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6><i class="bi bi-server me-2"></i>Server Info</h6>
                <table class="table table-sm table-dark" aria-label="Server information">
                  <tbody>
                    <tr>
                      <td>Address:</td>
                      <td class="font-monospace">{{ selectedServer()!.address.ip }}:{{ selectedServer()!.address.port }}</td>
                    </tr>
                    <tr>
                      <td>Version:</td>
                      <td>{{ selectedServer()!.versionMajor }}.{{ selectedServer()!.versionMinor }}.{{ selectedServer()!.versionPatch }}</td>
                    </tr>
                    <tr>
                      <td>Map:</td>
                      <td>{{ selectedServer()!.currentMap }}</td>
                    </tr>
                    <tr>
                      <td>Game Type:</td>
                      <td>{{ getGameTypeName(selectedServer()!.gameType) }}</td>
                    </tr>
                    <tr>
                      <td>Players:</td>
                      <td>{{ selectedServer()!.players.length }} / {{ selectedServer()!.maxPlayers }}</td>
                    </tr>
                    <tr>
                      <td>Max Clients:</td>
                      <td>{{ selectedServer()!.maxClients }}</td>
                    </tr>
                    <tr>
                      <td>Ping:</td>
                      <td [class]="getPingClass(selectedServer()!.ping)">{{ selectedServer()!.ping }}ms</td>
                    </tr>
                    <tr>
                      <td>Password:</td>
                      <td>{{ selectedServer()!.passwordHash ? 'Yes ðŸ”’' : 'No' }}</td>
                    </tr>
                    @if (getServerPWADs(selectedServer()!).length > 0) {
                      <tr>
                        <td>PWADs:</td>
                        <td>
                          <div class="d-flex flex-wrap gap-1">
                            @for (pwad of getServerPWADs(selectedServer()!); track pwad) {
                              <span class="badge bg-secondary">{{ pwad }}</span>
                            }
                          </div>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
              <div class="col-md-6">
                <h6 id="player-list-title"><i class="bi bi-people me-2"></i>Players ({{ selectedServer()!.players.length }})</h6>
                @if (selectedServer()!.players.length > 0) {
                  <ul class="list-group list-group-flush" aria-labelledby="player-list-title">
                    @for (player of selectedServer()!.players; track player.name) {
                      <li class="list-group-item bg-dark text-light" role="listitem">
                        <span aria-label="Player name">{{ player.name }}</span>
                        <span class="badge bg-secondary ms-2" aria-label="Frags: {{ player.frags }}">{{ player.frags }} frags</span>
                        <span class="badge bg-info ms-1" aria-label="Ping: {{ player.ping }} milliseconds">{{ player.ping }}ms</span>
                      </li>
                    }
                  </ul>
                } @else {
                  <p class="text-muted" role="status">No players online</p>
                }
              </div>
            </div>
            <div class="mt-3">
              <button 
                class="btn btn-success" 
                (click)="joinServer(selectedServer()!)"
                [disabled]="joiningServer()"
                [attr.aria-busy]="joiningServer()"
                aria-label="Join selected server">
                @if (joiningServer()) {
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Launching...
                } @else {
                  <i class="bi bi-play-fill"></i>
                  Join Server
                }
              </button>
            </div>
          </div>
        </div>
      } @else {
        <div class="card bg-dark border-secondary mb-0">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="bi bi-hdd-network me-2"></i>
              Server Details
            </h5>
            <button 
              class="btn btn-sm btn-outline-secondary" 
              (click)="toggleDetailsPanel()"
              [attr.aria-label]="detailsPanelCollapsed() ? 'Expand details panel' : 'Collapse details panel'"
              title="Toggle details panel">
              <i class="bi" [class.bi-chevron-down]="!detailsPanelCollapsed()" [class.bi-chevron-up]="detailsPanelCollapsed()"></i>
            </button>
          </div>
          <div class="card-body">
            <div class="empty-details">
              <i class="bi bi-arrow-up-circle"></i>
              <p>Select a server to view details</p>
            </div>
          </div>
        </div>
      }
    </div>
  